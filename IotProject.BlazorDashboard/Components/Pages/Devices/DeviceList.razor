@page "/devices"
@using IotProject.RazorShared.Models.Devices
@using IotProject.RazorShared.Models.Sensors
@using IotProject.RazorShared.Services
@using BlazorBootstrap
@using IotProject.Shared.Models.Responses
@inject IotDeviceService DeviceService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

    <div class="row justify-content-center">
        <div class="col-12">
        <Card Class="rounded-top-4 overflow-hidden lighter-border shadow card-gradient">
            <Card class="rounded-top-4 overflow-hidden">
                <CardHeader class="text-center p-3">
                    <h2 class="mb-0">List Of Devices</h2>
                </CardHeader>

                <CardBody class="">
                    <ul class="list-group">
                        @foreach (var device in PagedDevices)
                        {
                            <li class="list-group-item shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                                <div class="w-100">
                                    <span class="fw-bold fs-5 text-truncate d-block">@device.Name</span>
                                    <small class="text-muted">Room: @device.RoomId</small>
                                </div>
                                <a href="@($"device/{device.Id}")" class="stretched-link"></a>
                            </li>
                        }
                    </ul>
                </CardBody>

                <CardFooter class="d-flex justify-content-end p-3">
                    <Pagination Class="" ActivePageNumber="currentPage"
                    TotalPages="TotalPages"
                    DisplayPages="DisplayPages"
                    PageChanged="OnPageChanged"
                    FirstLinkIcon="IconName.ChevronDoubleLeft"
                    PreviousLinkIcon="IconName.ChevronLeft"
                    NextLinkIcon="IconName.ChevronRight"
                    LastLinkIcon="IconName.ChevronDoubleRight" />
                </CardFooter>
            </Card>
        </Card>
    </div>
</div>

@code {
    private List<DeviceResponse> devices = new();
    private int currentPage = 1;
    private const int PageSize = 5;
    private int DisplayPages = 1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var breakpointsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/breakpoints.js");
            await breakpointsModule.InvokeVoidAsync("onResize", DotNetObjectReference.Create(this));
            var breakpoint = await breakpointsModule.InvokeAsync<string>("getBootstrapBreakpoint");
            OnResize(breakpoint);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }

        devices = await DeviceService.GetAllDevices();

        // while (devices.Count < 30)
        // {
        //     devices.Add(new DeviceResponse($"{devices.Count + 1}", $"Demo Device {devices.Count + 1}", "DemoDevice", "", null, null));
        // }

		StateHasChanged();
    }

	[JSInvokable]
    public void OnResize(string breakpoint)
	{
        DisplayPages = breakpoint switch
        {
            "xs" => 1,
            "sm" => 3,
            _ => 5
        };
        StateHasChanged();
	}



	private int TotalPages => (int)Math.Ceiling((double)devices.Count / PageSize);

    private IEnumerable<DeviceResponse> PagedDevices =>
        devices.Skip((currentPage - 1) * PageSize).Take(PageSize);

    private async Task OnPageChanged(int newPage)
    {
        currentPage = newPage;
        await InvokeAsync(StateHasChanged);
    }

    private class DemoIotDevice : IotDevice
    {
        public DemoIotDevice(string name) : base(name)
        {
            Name = name;
            Data = "Demo Data";
        }

        public override List<IotSensor> GetSensors()
        {
            return new List<IotSensor>
            {
                new IotSensor { Name = "Demo Sensor 1", Device = this },
                new IotSensor { Name = "Demo Sensor 2", Device = this }
            };
        }
    }
}